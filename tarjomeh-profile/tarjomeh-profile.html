<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../tarjomeh-collection/tarjomeh-collection.html">

<dom-module id="tarjomeh-profile">

  <template>

    <style>
       
    </style>
    
    <tarjomeh-collection id="profileCollection" path="{{_computePath(fbUser)}}" data="{{profile}}"></tarjomeh-collection>
    
  </template>

  <script>
    Polymer({
      is: "tarjomeh-profile",
      properties: {
        fbUser: {
          type: Object,
          value: function(){
            return {};
          }
        },
        user: {
          type: Object,
          value: function(){
            return {};
          },
          notify: true
        }
      },
      
      ready: function() {
         
        //TODO refactor
        this.$.profileCollection.$.fbCollection.query.once("value", function(snapshot) {     
          
          if (this.profile.length === 0) {
            this.user = {};
            this.user.uid = this.fbUser.uid;
            this.user.provider = this.fbUser.provider;
          }
          else {
            this.user = this.profile[0];
          }
          
          //TODO refactor
          this.user.__firebaseKey__ = null;
          
          switch(this.user.provider) {
          case 'password':
            break;
          case 'google':
            this.user.name = this.fbUser.google.displayName;
            this.user.imageurl = this.fbUser.google.profileImageURL;
            break;
          default:
            throw 'Unknown provider: ' + this.user.provider;
          }
        
          this.$.profileCollection.addToChild('profile',this.user);

        }.bind(this), function (errorObject) {
          throw 'Profile could not be read!';
        });
      
      },
      
      _computePath: function(fbUser) {
        if (fbUser) {
          return 'users/' + fbUser.uid;
        }
        return null;
      }
      
    });
  </script>

</dom-module>