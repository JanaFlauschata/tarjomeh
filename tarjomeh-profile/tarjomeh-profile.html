<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../tarjomeh-collection/tarjomeh-collection.html">

<dom-module id="tarjomeh-profile">

  <template>

    <style>
       
    </style>
    
    <!--TODO add user-uid="{{fbUser.uid}}" again -->
    <tarjomeh-collection id="profileCollection" path="{{_computeBlaPath(uid)}}" data="{{data}}"></tarjomeh-collection>
    
  </template>

  <script>
    Polymer({
      is: "tarjomeh-profile",
      properties: {
        uid: {
          type: String,
          value: ''
        },
        fbUser: {
          type: Object,
          value: function () {
            return {};
          }
        },
        profile: {
          type: Object,
          value: function(){
            return {};
          },
          notify: true
        }
      },
      
      ready: function() {
        //TODO refactor
        this.$.profileCollection.$.fbCollection.query.once("value", function(snapshot) {     
          
          if (this.data.length === 0) {
            this.profile = {};
            this.profile.uid = this.fbUser.uid;
            if (this.fbUser) {
              this.profile.provider = this.fbUser.provider;
            }
          }
          else {
            this.profile = this.data[0];
          }
          
          //TODO refactor
          this.profile.__firebaseKey__ = null;
          
          if (this.fbUser.uid) { //TODO refactor
          switch(this.fbUser.provider) {
          case 'password':
            break;
          case 'google':
            this.profile.name = this.fbUser.google.displayName;
            this.profile.imageurl = this.fbUser.google.profileImageURL;
            break;
          default:
            throw 'Unknown provider: ' + this.fbUser.provider;
          }
          }
        
          this.$.profileCollection.addToChild('profile',this.profile);
        }.bind(this), function (errorObject) {
          throw 'Profile could not be read!';
        });
      
      },
      
      _computeBlaPath: function(bla) {
        if (bla !== '' && typeof bla !== 'undefined') {
          return 'users/' + bla;
        }
        return null;
      }
      
    });
  </script>

</dom-module>